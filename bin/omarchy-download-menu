#!/bin/bash

# === Config ===
OMARCHY_BIN="$HOME/.config/omarchy/bin"
export PATH="$OMARCHY_BIN:$PATH"

mkdir -p "$OMARCHY_BIN"

# === Helper Functions ===

menu() {
  local prompt="$1"
  local options="$2"
  local extra="$3"
  local preselect="$4"

  read -r -a args <<<"$extra"

  if [[ -n "$preselect" ]]; then
    local index
    index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    [[ -n "$index" ]] && args+=("-a" "$index")
  fi

  local choice
  choice=$(echo -e "$options" | walker --dmenu --theme dmenu_250 -p "$prompt…" "${args[@]}")

  # Exit if nothing is selected (Esc or click outside)
  [[ -z "$choice" ]] && exit 0

  echo "$choice"
}

present_terminal() {
  alacritty --class Omarchy -e bash -c "omarchy-show-logo; eval \"$1\"; omarchy-show-done;"
}

require_tool() {
  local tool="$1"
  command -v "$tool" >/dev/null 2>&1 || {
    echo "Error: '$tool' is not installed. Please install it first."
    read -rp "Press Enter to return to menu..."
    show_main_menu
    exit 1
  }
}

# === Download Actions ===

show_download_youtube_video() {
  require_tool "yt-dlp"
  present_terminal "omarchy-download-youtube-video"
}

show_download_file() {
  require_tool "aria2c"
  present_terminal "omarchy-download-file"
}

# === Menus ===

show_main_menu() {
  go_to_menu "$(menu "Download" "  File\n  YouTube Video")"
}

go_to_menu() {
  case "${1,,}" in
  *file*) show_download_file ;;
  *youtube*) show_download_youtube_video ;;

  esac
}

# === Entry Point ===
if [[ -n "$1" ]]; then
  go_to_menu "$1"
else
  show_main_menu
fi
